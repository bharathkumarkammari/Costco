<!DOCTYPE html>
<html>
<head>
  <title>Upload Costco Receipt to Google Drive</title>
  <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
  <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
  <script>
    const CLIENT_ID = "99397436308-j1g6c22j42jmoa0355gsieab7cmgubjt.apps.googleusercontent.com";
    const API_KEY = "AIzaSyAsYIv9OQPDiwTVEYOY2PnFY6ldsaTjtD4";
    const FOLDER_ID = "1RgeXz5ubmZmI7ejjN5VJJv-Le7HnFy_y";
    const SCOPES = "https://www.googleapis.com/auth/drive.file";

    let tokenClient;
    let accessToken = null;
    let gapiReady = false;
    let gisReady = false;

    function gapiLoaded() {
      gapi.load('client', async () => {
        await gapi.client.init({ apiKey: API_KEY });
        gapiReady = true;
        maybeEnableSignIn();
      });
    }

    function gisLoaded() {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (tokenResponse) => {
          accessToken = tokenResponse.access_token;
          document.getElementById("status").innerText = "‚úÖ Signed in. Ready to upload.";
        },
      });
      gisReady = true;
      maybeEnableSignIn();
    }

    function maybeEnableSignIn() {
      if (gapiReady && gisReady) {
        document.getElementById("signin").disabled = false;
        document.getElementById("status").innerText = "üîì Ready to sign in.";
      }
    }

    function authenticate() {
      if (!tokenClient) {
        document.getElementById("status").innerText = "‚è≥ Google not ready yet.";
        return;
      }
      tokenClient.requestAccessToken();
    }

    async function uploadFile() {
      const file = document.getElementById("fileInput").files[0];
      const status = document.getElementById("status");

      if (!file) {
        status.innerText = "‚ö†Ô∏è Please select a file.";
        return;
      }
      if (!accessToken) {
        status.innerText = "‚ùå Please sign in first.";
        return;
      }

      const metadata = {
        name: file.name,
        parents: [FOLDER_ID],
        mimeType: file.type,
      };

      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
      form.append('file', file);

      status.innerText = "‚è≥ Uploading...";

      try {
        const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
          method: 'POST',
          headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
          body: form
        });
        const result = await res.json();
        if (res.ok) {
          status.innerText = "‚úÖ Upload successful! File ID: " + result.id;
        } else {
          status.innerText = "‚ùå Upload failed: " + (result.error?.message || res.statusText);
        }
      } catch (err) {
        status.innerText = "‚ùå Upload error: " + err.message;
      }
    }
  </script>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; }
    button { padding: 8px 12px; margin-top: 10px; }
    #status { margin-top: 20px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üì§ Costco Receipt Upload</h2>
  <button id="signin" onclick="authenticate()" disabled>üîê Sign in with Google</button><br><br>
  <input type="file" id="fileInput" accept="application/pdf" />
  <button onclick="uploadFile()">üì§ Upload to Drive</button>
  <div id="status">‚è≥ Loading Google APIs...</div>
</body>
</html>